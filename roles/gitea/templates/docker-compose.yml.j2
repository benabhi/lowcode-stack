# ==============================================================================
# Gitea Docker Compose
# Generated by Ansible - DO NOT EDIT MANUALLY
# ==============================================================================

services:
  # ==========================================================================
  # PostgreSQL Database (Independent)
  # ==========================================================================
  gitea-db:
    image: {{ gitea_postgres_image }}:{{ gitea_postgres_version }}
    container_name: {{ gitea_postgres_container_name }}
    restart: unless-stopped
    volumes:
      - {{ gitea_install_path }}/data/postgres:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB={{ gitea_db_name }}
      - POSTGRES_USER={{ gitea_db_user }}
      - POSTGRES_PASSWORD={{ gitea_db_password }}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U {{ gitea_db_user }} -d {{ gitea_db_name }}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - {{ gitea_docker_network }}

  # ==========================================================================
  # Gitea Application
  # ==========================================================================
  gitea:
    image: {{ gitea_image }}:{{ gitea_version }}
    container_name: {{ gitea_container_name }}
    restart: unless-stopped
    ports:
      - "{{ gitea_http_port }}:3000"
      - "{{ gitea_ssh_port }}:22"
    volumes:
      - {{ gitea_install_path }}/data/gitea:/data
      - {{ gitea_install_path }}/config:/data/gitea/conf
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    environment:
      # App settings
      - GITEA__DEFAULT__APP_NAME={{ gitea_app_name }}
      - GITEA__server__DOMAIN={{ gitea_domain }}
      - GITEA__server__SSH_DOMAIN={{ gitea_ssh_domain }}
      - GITEA__server__ROOT_URL={{ gitea_root_url }}
      - GITEA__server__SSH_PORT={{ gitea_ssh_external_port }}
      - GITEA__server__SSH_LISTEN_PORT={{ gitea_ssh_listen_port }}
      - GITEA__server__LFS_START_SERVER=true

      # Database configuration (own PostgreSQL)
      - GITEA__database__DB_TYPE={{ gitea_db_type }}
      - GITEA__database__HOST={{ gitea_db_host }}:{{ gitea_db_port }}
      - GITEA__database__NAME={{ gitea_db_name }}
      - GITEA__database__USER={{ gitea_db_user }}
      - GITEA__database__PASSWD={{ gitea_db_password }}

      # Service settings
      - GITEA__service__DISABLE_REGISTRATION={{ gitea_disable_registration | string | lower }}
      - GITEA__service__REQUIRE_SIGNIN_VIEW={{ gitea_require_signin | string | lower }}

      # Security
      - GITEA__security__INSTALL_LOCK=true

    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000/api/v1/version || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - {{ gitea_docker_network }}
    depends_on:
      gitea-db:
        condition: service_healthy

networks:
  {{ gitea_docker_network }}:
    external: true
