# ==============================================================================
# Role: nginx - HTTP Basic Authentication Tasks
# ==============================================================================

---
- name: Install apache2-utils for htpasswd
  ansible.builtin.apt:
    name: apache2-utils
    state: present
  become: true

- name: Create htpasswd files for services with basic auth
  ansible.builtin.shell: |
    htpasswd -cb /etc/nginx/.htpasswd_{{ item.name }} {{ nginx_htpasswd_users[0].username }} '{{ nginx_htpasswd_users[0].password }}'
  become: true
  loop: "{{ nginx_sites | selectattr('basic_auth', 'defined') | selectattr('basic_auth', 'equalto', true) | list }}"
  when: nginx_htpasswd_users | length > 0
  no_log: true  # Hide passwords from logs
  changed_when: true

- name: Set permissions on htpasswd files
  ansible.builtin.file:
    path: "/etc/nginx/.htpasswd_{{ item.name }}"
    owner: root
    group: "{{ nginx_user }}"
    mode: '0640'
  become: true
  loop: "{{ nginx_sites | selectattr('basic_auth', 'defined') | selectattr('basic_auth', 'equalto', true) | list }}"
  when: nginx_htpasswd_users | length > 0
