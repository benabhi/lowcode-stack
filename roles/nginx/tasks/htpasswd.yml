# ==============================================================================
# Role: nginx - HTTP Basic Authentication Tasks
# ==============================================================================

---
- name: Install passlib for htpasswd module
  ansible.builtin.apt:
    name: python3-passlib
    state: present
  become: true

- name: Create htpasswd files for services with basic auth
  community.general.htpasswd:
    path: "/etc/nginx/.htpasswd_{{ item.name }}"
    name: "{{ nginx_htpasswd_users[0].username }}"
    password: "{{ nginx_htpasswd_users[0].password }}"
    owner: root
    group: "{{ nginx_user }}"
    mode: '0640'
  become: true
  loop: "{{ nginx_sites | selectattr('basic_auth', 'defined') | selectattr('basic_auth', 'equalto', true) | list }}"
  when: nginx_htpasswd_users | length > 0
  no_log: true
