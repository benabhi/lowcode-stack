# ==============================================================================
# n8n Docker Compose
# Generated by Ansible - DO NOT EDIT MANUALLY
# ==============================================================================

services:
  # ==========================================================================
  # Redis Cache (Independent - for queue mode)
  # ==========================================================================
{% if n8n_redis_enabled %}
  n8n-redis:
    image: {{ n8n_redis_image }}:{{ n8n_redis_version }}
    container_name: {{ n8n_redis_container_name }}
    restart: unless-stopped
    command: redis-server --requirepass {{ n8n_redis_password }} --appendonly yes
    volumes:
      - n8n_redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "{{ n8n_redis_password }}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - {{ n8n_docker_network }}
{% endif %}

  # ==========================================================================
  # n8n Application
  # ==========================================================================
  n8n:
    image: {{ n8n_image }}:{{ n8n_version }}
    container_name: {{ n8n_container_name }}
    restart: unless-stopped
    ports:
      - "{{ n8n_port }}:5678"
    volumes:
      - n8n_data:/home/node/.n8n
    environment:
      # Basic configuration
      - N8N_HOST={{ n8n_host }}
      - N8N_PORT=5678
      - N8N_PROTOCOL={{ n8n_protocol }}
      - NODE_ENV=production
      - WEBHOOK_URL={{ n8n_webhook_url }}
      - GENERIC_TIMEZONE={{ n8n_timezone }}

{% if n8n_encryption_key %}
      # Encryption
      - N8N_ENCRYPTION_KEY={{ n8n_encryption_key }}
{% endif %}

      # Database configuration
{% if n8n_db_type == 'sqlite' %}
      - DB_TYPE=sqlite
      - DB_SQLITE_DATABASE={{ n8n_db_sqlite_path }}
{% else %}
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST={{ n8n_db_postgres_host }}
      - DB_POSTGRESDB_PORT={{ n8n_db_postgres_port }}
      - DB_POSTGRESDB_DATABASE={{ n8n_db_postgres_database }}
      - DB_POSTGRESDB_USER={{ n8n_db_postgres_user }}
      - DB_POSTGRESDB_PASSWORD={{ n8n_db_postgres_password }}
{% endif %}

      # Execution settings
      - EXECUTIONS_MODE={{ n8n_executions_mode }}
      - EXECUTIONS_DATA_SAVE_ON_ERROR={{ n8n_executions_data_save_on_error }}
      - EXECUTIONS_DATA_SAVE_ON_SUCCESS={{ n8n_executions_data_save_on_success }}
      - EXECUTIONS_DATA_SAVE_MANUAL_EXECUTIONS={{ n8n_executions_data_save_manual | string | lower }}

{% if n8n_redis_enabled %}
      # Redis for queue/caching (own container)
      - QUEUE_BULL_REDIS_HOST={{ n8n_redis_host }}
      - QUEUE_BULL_REDIS_PORT={{ n8n_redis_port }}
      - QUEUE_BULL_REDIS_PASSWORD={{ n8n_redis_password }}
{% endif %}

{% if n8n_smtp_enabled %}
      # SMTP configuration
      - N8N_EMAIL_MODE=smtp
      - N8N_SMTP_HOST={{ n8n_smtp_host }}
      - N8N_SMTP_PORT={{ n8n_smtp_port }}
      - N8N_SMTP_USER={{ n8n_smtp_user }}
      - N8N_SMTP_PASS={{ n8n_smtp_password }}
      - N8N_SMTP_SENDER={{ n8n_smtp_sender }}
{% endif %}

    healthcheck:
      test: ["CMD-SHELL", "wget --spider -q http://127.0.0.1:5678/healthz || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - {{ n8n_docker_network }}
{% if n8n_redis_enabled %}
    depends_on:
      n8n-redis:
        condition: service_healthy
{% endif %}

volumes:
  n8n_data:
    driver: local
{% if n8n_redis_enabled %}
  n8n_redis_data:
    driver: local
{% endif %}

networks:
  {{ n8n_docker_network }}:
    external: true
