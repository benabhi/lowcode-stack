# ==============================================================================
# Docmost Docker Compose
# Generated by Ansible - DO NOT EDIT MANUALLY
# ==============================================================================

services:
  # ==========================================================================
  # PostgreSQL Database (Independent)
  # ==========================================================================
  docmost-db:
    image: {{ docmost_postgres_image }}:{{ docmost_postgres_version }}
    container_name: {{ docmost_postgres_container_name }}
    restart: unless-stopped
    volumes:
      - {{ docmost_install_path }}/data/postgres:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB={{ docmost_db_name }}
      - POSTGRES_USER={{ docmost_db_user }}
      - POSTGRES_PASSWORD={{ docmost_db_password }}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U {{ docmost_db_user }} -d {{ docmost_db_name }}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - {{ docmost_docker_network }}

  # ==========================================================================
  # Redis Cache (Independent)
  # ==========================================================================
  docmost-redis:
    image: {{ docmost_redis_image }}:{{ docmost_redis_version }}
    container_name: {{ docmost_redis_container_name }}
    restart: unless-stopped
    command: redis-server --requirepass {{ docmost_redis_password }} --appendonly yes
    volumes:
      - {{ docmost_install_path }}/data/redis:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "{{ docmost_redis_password }}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - {{ docmost_docker_network }}

  # ==========================================================================
  # Docmost Application
  # ==========================================================================
  docmost:
    image: {{ docmost_image }}:{{ docmost_version }}
    container_name: {{ docmost_container_name }}
    restart: unless-stopped
    ports:
      - "{{ docmost_http_port }}:3000"
    volumes:
      - {{ docmost_install_path }}/data/storage:/app/data/storage
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    environment:
      # Application settings
      - APP_URL={{ docmost_app_url }}
      - APP_SECRET={{ docmost_app_secret }}

      # Database configuration (own PostgreSQL)
      - DATABASE_URL={{ docmost_database_url }}

      # Redis configuration (own Redis)
      - REDIS_URL={{ docmost_redis_url }}

      # Storage configuration
      - STORAGE_DRIVER={{ docmost_storage_driver }}

    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:3000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - {{ docmost_docker_network }}
    depends_on:
      docmost-db:
        condition: service_healthy
      docmost-redis:
        condition: service_healthy

networks:
  {{ docmost_docker_network }}:
    external: true
