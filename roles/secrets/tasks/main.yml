# ==============================================================================
# Secrets Role - Main Tasks
# ==============================================================================
# This role auto-generates and manages all service secrets.
# Secrets are stored on the server and reused on subsequent deployments.
# ==============================================================================

---
- name: Ensure base directory exists
  ansible.builtin.file:
    path: "{{ lowcode_base_path }}"
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Check if secrets file exists
  ansible.builtin.stat:
    path: "{{ secrets_file_path }}"
  register: secrets_file_stat

- name: Generate new secrets
  when: not secrets_file_stat.stat.exists
  block:
    - name: Generate random secrets
      ansible.builtin.set_fact:
        generated_secrets:
          # Supabase
          supabase_postgres_password: "{{ lookup('community.general.random_string', length=32, special=false) }}"
          supabase_jwt_secret: "{{ lookup('community.general.random_string', length=43, special=false, base64=true) }}"
          supabase_dashboard_username: "admin"
          supabase_dashboard_password: "{{ lookup('community.general.random_string', length=16, special=false) }}"
          # n8n
          n8n_encryption_key: "{{ lookup('community.general.random_string', length=32, special=false) | hash('md5') }}"
          n8n_basic_auth_user: "admin"
          n8n_basic_auth_password: "{{ lookup('community.general.random_string', length=16, special=false) }}"
          # Appsmith
          appsmith_encryption_password: "{{ lookup('community.general.random_string', length=32, special=false) }}"
          appsmith_encryption_salt: "{{ lookup('community.general.random_string', length=32, special=false) }}"
          # Redis
          redis_password: "{{ lookup('community.general.random_string', length=32, special=false) }}"
          # Nginx Basic Auth
          nginx_htpasswd_username: "admin"
          nginx_htpasswd_password: "{{ lookup('community.general.random_string', length=16, special=false) }}"
          # Generation timestamp
          generated_at: "{{ ansible_date_time.iso8601 }}"

    - name: Generate Supabase JWT keys using Python
      ansible.builtin.shell: |
        python3 << 'PYTHON_SCRIPT'
        import base64
        import hmac
        import hashlib
        import json
        import time

        jwt_secret = "{{ generated_secrets.supabase_jwt_secret }}"

        def create_jwt(secret, role):
            # Header
            header = {"alg": "HS256", "typ": "JWT"}
            header_b64 = base64.urlsafe_b64encode(json.dumps(header).encode()).rstrip(b'=').decode()

            # Payload - expires in 10 years
            exp = int(time.time()) + (10 * 365 * 24 * 60 * 60)
            payload = {
                "role": role,
                "iss": "supabase",
                "iat": int(time.time()),
                "exp": exp
            }
            payload_b64 = base64.urlsafe_b64encode(json.dumps(payload).encode()).rstrip(b'=').decode()

            # Signature
            message = f"{header_b64}.{payload_b64}"
            signature = hmac.new(secret.encode(), message.encode(), hashlib.sha256).digest()
            signature_b64 = base64.urlsafe_b64encode(signature).rstrip(b'=').decode()

            return f"{header_b64}.{payload_b64}.{signature_b64}"

        anon_key = create_jwt(jwt_secret, "anon")
        service_key = create_jwt(jwt_secret, "service_role")

        print(f"ANON_KEY={anon_key}")
        print(f"SERVICE_KEY={service_key}")
        PYTHON_SCRIPT
      register: jwt_generation_result
      changed_when: false

    - name: Parse generated JWT keys
      ansible.builtin.set_fact:
        supabase_anon_key: "{{ jwt_generation_result.stdout_lines | select('match', '^ANON_KEY=') | first | regex_replace('^ANON_KEY=', '') }}"
        supabase_service_key: "{{ jwt_generation_result.stdout_lines | select('match', '^SERVICE_KEY=') | first | regex_replace('^SERVICE_KEY=', '') }}"

    - name: Add JWT keys to secrets
      ansible.builtin.set_fact:
        generated_secrets: "{{ generated_secrets | combine({
          'supabase_anon_key': supabase_anon_key,
          'supabase_service_role_key': supabase_service_key
        }) }}"

    - name: Save secrets to server
      ansible.builtin.copy:
        content: "{{ generated_secrets | to_nice_yaml }}"
        dest: "{{ secrets_file_path }}"
        owner: "{{ secrets_file_owner }}"
        group: "{{ secrets_file_group }}"
        mode: "{{ secrets_file_mode }}"

    - name: Set flag for new secrets
      ansible.builtin.set_fact:
        secrets_newly_generated: true

- name: Load secrets from file
  ansible.builtin.slurp:
    src: "{{ secrets_file_path }}"
  register: secrets_file_content

- name: Parse secrets
  ansible.builtin.set_fact:
    lowcode_secrets: "{{ secrets_file_content.content | b64decode | from_yaml }}"

- name: Display generated secrets
  when: secrets_newly_generated | default(false) and secrets_display_on_create
  block:
    - name: Show secrets banner
      ansible.builtin.debug:
        msg: |

          ╔══════════════════════════════════════════════════════════════════╗
          ║           SECRETOS GENERADOS - GUARDAR EN LUGAR SEGURO           ║
          ╚══════════════════════════════════════════════════════════════════╝

    - name: Show Supabase credentials
      ansible.builtin.debug:
        msg: |
          ══════════════════════════════════════════════════════════════════
          SUPABASE
          ══════════════════════════════════════════════════════════════════
          PostgreSQL Password: {{ lowcode_secrets.supabase_postgres_password }}
          JWT Secret:          {{ lowcode_secrets.supabase_jwt_secret }}
          Dashboard User:      {{ lowcode_secrets.supabase_dashboard_username }}
          Dashboard Password:  {{ lowcode_secrets.supabase_dashboard_password }}

    - name: Show n8n credentials
      ansible.builtin.debug:
        msg: |
          ══════════════════════════════════════════════════════════════════
          N8N
          ══════════════════════════════════════════════════════════════════
          User:     {{ lowcode_secrets.n8n_basic_auth_user }}
          Password: {{ lowcode_secrets.n8n_basic_auth_password }}

    - name: Show Appsmith info
      ansible.builtin.debug:
        msg: |
          ══════════════════════════════════════════════════════════════════
          APPSMITH
          ══════════════════════════════════════════════════════════════════
          (Crear usuario en primer acceso via web)

    - name: Show Nginx Basic Auth credentials
      ansible.builtin.debug:
        msg: |
          ══════════════════════════════════════════════════════════════════
          NGINX BASIC AUTH (Supabase Studio)
          ══════════════════════════════════════════════════════════════════
          User:     {{ lowcode_secrets.nginx_htpasswd_username }}
          Password: {{ lowcode_secrets.nginx_htpasswd_password }}

    - name: Show URLs
      ansible.builtin.debug:
        msg: |
          ══════════════════════════════════════════════════════════════════
          URLs DE ACCESO
          ══════════════════════════════════════════════════════════════════
          Supabase Studio: https://{{ lowcode_domain_supabase }}
          Appsmith:        https://{{ lowcode_domain_appsmith }}
          n8n:             https://{{ lowcode_domain_n8n }}
          ══════════════════════════════════════════════════════════════════

          Los secretos estan guardados en: {{ secrets_file_path }}

- name: Confirm secrets loaded
  ansible.builtin.debug:
    msg: "Secrets loaded from {{ secrets_file_path }} (generated: {{ lowcode_secrets.generated_at | default('unknown') }})"
  when: not (secrets_newly_generated | default(false))
