# ==============================================================================
# Windmill Docker Compose
# Generated by Ansible - DO NOT EDIT MANUALLY
# ==============================================================================

services:
  # ==========================================================================
  # PostgreSQL Database (Independent)
  # ==========================================================================
  windmill-db:
    image: {{ windmill_postgres_image }}:{{ windmill_postgres_version }}
    container_name: {{ windmill_postgres_container_name }}
    restart: unless-stopped
    shm_size: 1g
    volumes:
      - {{ windmill_install_path }}/data/postgres:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB={{ windmill_db_name }}
      - POSTGRES_USER={{ windmill_db_user }}
      - POSTGRES_PASSWORD={{ windmill_db_password }}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U {{ windmill_db_user }} -d {{ windmill_db_name }}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - {{ windmill_docker_network }}

  # ==========================================================================
  # Windmill Server
  # ==========================================================================
  windmill_server:
    image: {{ windmill_image }}:{{ windmill_version }}
    container_name: {{ windmill_container_name }}-server
    restart: unless-stopped
    ports:
      - "{{ windmill_http_port }}:8000"
    environment:
      - DATABASE_URL={{ windmill_database_url }}
      - MODE=server
      - BASE_URL={{ windmill_base_url }}
    volumes:
      - {{ windmill_install_path }}/data/worker_logs:/tmp/windmill/logs
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/api/version || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - {{ windmill_docker_network }}
    depends_on:
      windmill-db:
        condition: service_healthy

  # ==========================================================================
  # Windmill Worker (Default)
  # ==========================================================================
  windmill_worker:
    image: {{ windmill_image }}:{{ windmill_version }}
    container_name: {{ windmill_container_name }}-worker
    restart: unless-stopped
    deploy:
      replicas: {{ windmill_worker_replicas }}
      resources:
        limits:
          cpus: "{{ windmill_worker_cpu_limit }}"
          memory: {{ windmill_worker_memory_limit }}
    environment:
      - DATABASE_URL={{ windmill_database_url }}
      - MODE=worker
      - WORKER_GROUP=default
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - {{ windmill_install_path }}/data/worker_cache:/tmp/windmill/cache
      - {{ windmill_install_path }}/data/worker_logs:/tmp/windmill/logs
    networks:
      - {{ windmill_docker_network }}
    depends_on:
      windmill-db:
        condition: service_healthy

  # ==========================================================================
  # Windmill Worker Native (Lightweight jobs)
  # ==========================================================================
  windmill_worker_native:
    image: {{ windmill_image }}:{{ windmill_version }}
    container_name: {{ windmill_container_name }}-worker-native
    restart: unless-stopped
    deploy:
      replicas: {{ windmill_native_worker_replicas }}
      resources:
        limits:
          cpus: "{{ windmill_worker_cpu_limit }}"
          memory: {{ windmill_worker_memory_limit }}
    environment:
      - DATABASE_URL={{ windmill_database_url }}
      - MODE=worker
      - WORKER_GROUP=native
      - NUM_WORKERS=8
      - SLEEP_QUEUE=200
    volumes:
      - {{ windmill_install_path }}/data/worker_logs:/tmp/windmill/logs
    networks:
      - {{ windmill_docker_network }}
    depends_on:
      windmill-db:
        condition: service_healthy

  # ==========================================================================
  # Windmill LSP (Language Server Protocol)
  # ==========================================================================
  windmill_lsp:
    image: {{ windmill_lsp_image }}:{{ windmill_lsp_version }}
    container_name: {{ windmill_container_name }}-lsp
    restart: unless-stopped
    ports:
      - "{{ windmill_lsp_port }}:3001"
    volumes:
      - {{ windmill_install_path }}/data/lsp_cache:/pyls/.cache
    networks:
      - {{ windmill_docker_network }}

networks:
  {{ windmill_docker_network }}:
    external: true
