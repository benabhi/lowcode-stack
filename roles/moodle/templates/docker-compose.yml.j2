# ==============================================================================
# Moodle Docker Compose
# Generated by Ansible - DO NOT EDIT MANUALLY
# ==============================================================================

services:
  # ==========================================================================
  # MariaDB Database (Independent)
  # ==========================================================================
  moodle-db:
    image: {{ moodle_mariadb_image }}:{{ moodle_mariadb_version }}
    container_name: {{ moodle_mariadb_container_name }}
    restart: unless-stopped
    volumes:
      - {{ moodle_install_path }}/data/mariadb:/var/lib/mysql
    environment:
      - MYSQL_ROOT_PASSWORD={{ moodle_db_root_password }}
      - MYSQL_DATABASE={{ moodle_db_name }}
      - MYSQL_USER={{ moodle_db_user }}
      - MYSQL_PASSWORD={{ moodle_db_password }}
      - MARIADB_CHARACTER_SET=utf8mb4
      - MARIADB_COLLATE=utf8mb4_unicode_ci
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - {{ moodle_docker_network }}

  # ==========================================================================
  # Moodle Application
  # ==========================================================================
  moodle:
    image: {{ moodle_image }}:{{ moodle_version }}
    container_name: {{ moodle_container_name }}
    restart: unless-stopped
    ports:
      - "{{ moodle_http_port }}:8080"
    volumes:
      - {{ moodle_install_path }}/data/moodle:/bitnami/moodle
      - {{ moodle_install_path }}/data/moodledata:/bitnami/moodledata
    environment:
      # Database configuration (MariaDB/MySQL)
      - MOODLE_DATABASE_TYPE=mariadb
      - MOODLE_DATABASE_HOST={{ moodle_db_host }}
      - MOODLE_DATABASE_PORT_NUMBER={{ moodle_db_port }}
      - MOODLE_DATABASE_NAME={{ moodle_db_name }}
      - MOODLE_DATABASE_USER={{ moodle_db_user }}
      - MOODLE_DATABASE_PASSWORD={{ moodle_db_password }}

      # Site configuration
      - MOODLE_SITE_NAME={{ moodle_site_name }}
      - MOODLE_USERNAME={{ moodle_username }}
      - MOODLE_PASSWORD={{ moodle_password }}
      - MOODLE_EMAIL={{ moodle_email }}
      - MOODLE_HOST={{ moodle_domain }}

      # Reverse proxy configuration
      - MOODLE_SKIP_BOOTSTRAP=no
      - MOODLE_REVERSEPROXY={{ moodle_reverseproxy | default('false') }}
      - MOODLE_SSLPROXY={{ moodle_sslproxy | default('false') }}

      # PHP settings
      - PHP_MEMORY_LIMIT=512M
      - PHP_MAX_UPLOAD_SIZE=100M

    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 300s
    networks:
      - {{ moodle_docker_network }}
    depends_on:
      moodle-db:
        condition: service_healthy

networks:
  {{ moodle_docker_network }}:
    external: true
