# ==============================================================================
# Setup Playbook - System Configuration Only
# ==============================================================================
# This playbook only configures the base system without deploying services.
# Useful for preparing a server before deployment.
#
# Usage:
#   ansible-playbook playbooks/setup.yml
# ==============================================================================

---
- name: Setup Server for Low-Code Stack
  hosts: lowcode_servers
  become: true

  pre_tasks:
    - name: Verify target is Ubuntu 24.04
      ansible.builtin.assert:
        that:
          - ansible_distribution == 'Ubuntu'
          - ansible_distribution_version == '24.04'
        fail_msg: "This playbook requires Ubuntu 24.04 LTS"
      tags: always

    - name: Display setup info
      ansible.builtin.debug:
        msg:
          - "SERVER SETUP"
          - "Target: {{ inventory_hostname }} ({{ ansible_host }})"
          - "Components: packages, UFW, Docker, user={{ lowcode_system_user }}"
      tags: always

  roles:
    - role: common
      tags: [common, setup]

    - role: geerlingguy.docker
      tags: [docker, setup]
      vars:
        docker_install_compose_plugin: true
        docker_users:
          - "{{ lowcode_system_user }}"

  post_tasks:
    - name: Display setup summary
      ansible.builtin.debug:
        msg:
          - "SERVER SETUP COMPLETE!"
          - "Next: ansible-playbook playbooks/deploy.yml --ask-pass"
