# ==============================================================================
# Setup Playbook - System Configuration Only
# ==============================================================================
# This playbook only configures the base system without deploying services.
# Useful for preparing a server before deployment.
#
# Usage:
#   ansible-playbook playbooks/setup.yml
# ==============================================================================

---
- name: Setup Server for Low-Code Stack
  hosts: lowcode_servers
  become: true

  pre_tasks:
    - name: Verify target is Ubuntu 24.04
      ansible.builtin.assert:
        that:
          - ansible_distribution == 'Ubuntu'
          - ansible_distribution_version == '24.04'
        fail_msg: "This playbook requires Ubuntu 24.04 LTS"

    - name: Display setup info
      ansible.builtin.debug:
        msg: |
          =============================================
          SERVER SETUP
          =============================================
          Target: {{ inventory_hostname }} ({{ ansible_host }})
          This will configure:
            - System packages and updates
            - Firewall (UFW)
            - Docker CE
            - System user: {{ lowcode_system_user }}
            - Base directory: {{ lowcode_base_path }}
          =============================================

  roles:
    - role: common
      tags: [common, setup]

    - role: geerlingguy.docker
      tags: [docker, setup]
      vars:
        docker_install_compose_plugin: true
        docker_users:
          - "{{ lowcode_system_user }}"

  post_tasks:
    - name: Display setup summary
      ansible.builtin.debug:
        msg: |
          =============================================
          SERVER SETUP COMPLETE!
          =============================================
          Server is ready for deployment.

          Next steps:
            ansible-playbook playbooks/deploy.yml --ask-vault-pass

          Or deploy everything at once:
            ansible-playbook playbooks/site.yml --ask-vault-pass
          =============================================
