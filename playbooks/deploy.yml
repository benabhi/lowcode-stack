# ==============================================================================
# Deploy Playbook - Services Deployment Only
# ==============================================================================
# This playbook deploys all services assuming the server is already configured.
# Run setup.yml first if the server is not prepared.
#
# Usage:
#   docker compose run --rm ansible playbooks/deploy.yml --ask-pass
# ==============================================================================

---
- name: Deploy Low-Code Stack Services
  hosts: lowcode_servers
  become: true

  pre_tasks:
    - name: Check if Docker is installed
      ansible.builtin.command: docker --version
      register: docker_check
      changed_when: false
      failed_when: docker_check.rc != 0
      tags: always

    - name: Display deployment info
      ansible.builtin.debug:
        msg:
          - "SERVICES DEPLOYMENT"
          - "Target: {{ inventory_hostname }} ({{ ansible_host }})"
          - "Services: Redis, Supabase, Appsmith, n8n, Windmill (optional), Nginx"
      tags: always

  roles:
    - role: secrets
      tags: [secrets, always]

    - role: redis
      tags: [redis, deploy]

    - role: supabase
      tags: [supabase, deploy]

    - role: appsmith
      tags: [appsmith, deploy]

    - role: n8n
      tags: [n8n, deploy]

    - role: windmill
      tags: [windmill, deploy, optional]
      when: lowcode_enable_windmill | default(false) | bool

    - role: nginx
      tags: [nginx, deploy]

  post_tasks:
    - name: Display deployment summary
      ansible.builtin.debug:
        msg:
          - "DEPLOYMENT COMPLETE!"
          - "URLs: https://{{ lowcode_domain_supabase }} | https://{{ lowcode_domain_n8n }} | https://{{ lowcode_domain_appsmith }}"
